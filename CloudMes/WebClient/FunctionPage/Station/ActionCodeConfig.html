<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
    <meta http-equiv="expires" content="0">
    <title set-lan="html:Title">MES</title>
    <meta charset="utf-8">
    <meta name="author" content="fgg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../../css/plugins/bootstrap/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../../css/plugins/font-awesome/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../../css/animate.css" rel="stylesheet">
    <link href="../../css/style.css?v=4.1.0" rel="stylesheet">
    <link href="../../css/plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="../../css/plugins/bootstrapTable/bootstrap-table.min.css" rel="stylesheet" />
    <link href="../../css/plugins/bootstrapDateTimePicker/bootstrap-datetimepicker.min.css" rel="stylesheet" />

    <style type="text/css">
        #ConfigView {
            display: none;
        }

        .div-table-tool {
            float: left;
            padding: 0px;
            margin: 0px;
        }

        #toolbar .btn:last-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
    </style>
</head>
<body class="gray-bg">
    <div class="wrapper wrapper-content  animated fadeInRight">
        <div class="panel-heading bg-primary">
            <h3><i class="glyphicon glyphicon-tags"><lan set-lan="html:ActionCodeView" style="padding-left:10px;" id="TitleName">ActionCode</lan></i></h3>
        </div>
        <div class="ibox-content">
            <div id="ActionCodeView">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="form-group">
                            <div class="col-xs-5   col-sm-6  col-md-5  col-lg-4 col-xs-offset-2">
                                <input type="text" set-lan="attr:placeholder=PlaceholderSearchContent" class="form-control" id="SearchText">
                            </div>
                            <div class="col-xs-3   col-sm-2 col-md-2  col-lg-1"><button class="btn btn-primary" id="Search"><i class="fa fa-search"><lan set-lan="html:Search">Search</lan></i></button></div>
                        </div>
                    </div>
                </div>
                <p></p>
                <div class="row">
                    <div class="bootstrap-table">
                        <div class="fixed-table-toolbar">
                            <div class="btn-group div-table-tool" id="toolbar" role="group">
                                <button type="button" class="btn btn-outline btn-default" id="AddClick">
                                    <i class="glyphicon glyphicon-plus" aria-hidden="true"></i><lan set-lan="html:add">Add</lan>
                                </button>
                                <button type="button" class="btn btn-outline btn-default" id="ModifyClick">
                                    <i class="glyphicon glyphicon-pencil" aria-hidden="true"></i><lan set-lan="html:edit">Modify</lan>
                                </button>
                                <button type="button" class="btn btn-outline btn-default" id="Delclick">
                                    <i class="glyphicon glyphicon-trash" aria-hidden="true"></i><lan set-lan="html:delete">Delete</lan>
                                </button>
                            </div>
                        </div>
                        <table class="table table-hover" id="ActionCodeTable"></table>
                    </div>
                </div>
            </div>
            <div id="ConfigView">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-bottom: 10px;margin-top: -10px;">
                        <button type="button" class="btn btn-primary" id="GoBack"><i class="fa fa-step-backward"></i> <lan set-lan="html:back">返回</lan></button>
                    </div>
                </div>
                <div class="row">
                    <form role="form" class="form-horizontal m-t">
                        <div class="col-sm-12">
                            <div class="form-group draggable" id="ErrorMessage">
                                <label class="col-sm-3 control-label" set-lan="html:ActionCode">ACTION_CODE：</label>
                                <div class="col-sm-5">
                                    <input type="text" class="form-control" id="ACTION_CODE" set-lan="attr:placeholder=PlaceholderActionCode"  />
                                </div>
                                <div class="col-sm-4">
                                    <label class="control-label" id="MessageText"></label>
                                </div>
                            </div>
                            <div class="form-group draggable">
                                <label class="col-sm-3 control-label" set-lan="html:EnglishDescription">ENGLISH_DESCRIPTION：</label>
                                <div class="col-sm-5">
                                    <input type="text" class="form-control" id="EN_DESCRIPTION"  set-lan="attr:placeholder=PlaceholderEnglishDescription" />
                                </div>
                                <div class="col-sm-4">
                                    <label class="control-label"> </label>
                                </div>
                            </div>

                            <div class="form-group draggable">
                                <label class="col-sm-3 control-label" set-lan="html:ChineseDescription">CHINESE_DESCRIPTION：</label>
                                <div class="col-sm-5">
                                    <input type="text" class="form-control" id="CHN_DESCRIPTION" set-lan="attr:placeholder=PlaceholderChineseDescription"  />
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-2"></div>
                        <div class="hr-line-dashed col-sm-12"></div>
                        <div class="form-group draggable">
                            <div class="col-sm-12 col-sm-offset-5 col-xs-offset-5">
                                <button type="button" class="btn btn-primary" id="AddSave"><i class="fa fa-pencil" set-lan="html:save">保存信息</i></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- 全局js -->
    <script src="../../Scripts/plugins/jquery/jquery.min.js?v=2.1.4"></script>
    <script src="../../Scripts/plugins/jquery/jquery.cookie.js"></script>
    <script src="../../Scripts/plugins/bootstrap/bootstrap.min.js?v=3.3.6"></script>
    <script src="../../Scripts/plugins/JSON/json2.js"></script>
    <!-- 第三方插件 -->
    <script src="../../Scripts/plugins/bootstrapTable/bootstrap-table.min.js"></script>
    <script src="../../Scripts/plugins/bootstrapTable/bootstrap-table-export.min.js"></script>
    <script src="../../Scripts/plugins/bootstrapTable/tableExport.min.js"></script>
    <script src="../../Scripts/plugins/bootstrapTable/bootstrap-table-zh-TW.min.js"></script>
    <script src="../../Scripts/plugins/bootstrapTable/bootstrap-table-zh-CN.min.js"></script>
    <script src="../../Scripts/plugins/sweetalert/sweetalert.min.js"></script>
    <!--自定義插件-->
    <script src="../../Scripts/global.js"></script>
    <script src="../../Scripts/MesClient.UI.js"></script>
    <script>
        var localelan = "";
        var lan = $.cookie($.MES.CK_LAN_NAME);
        var check = "";
        $(document).ready(function () {
            var LoginName = self.parent.client.UserInfo.EMP_NO;
            var LoginLevel = self.parent.client.UserInfo.EMP_LEVEL;
            var mesUI = new MesClientUI(self.parent.client);
            if (lan == "CHINESE") {
                localelan = "zh-CN"
            }
            else if (lan == "CHINESE_TW") {
                localelan = "zh-TW"
            }
            else {
                localelan = "en"
            }
            //初始加載
            function LoadData() {
                var ClassName = "MESStation.Config.CActionCodeConfig";
                var FunctionName = "GetAllActionCode";
                self.parent.client.CallFunction(ClassName, FunctionName, {}, function (e) {
                    if (e.Status == "Pass") {
                        ShowTable(e.Data, "#ActionCodeTable");
                        //去掉導出數據按鈕的左上左下圓角
                        $("lan:contains('Export Data')").parent().css({ 'border-top-left-radius': '0', 'border-bottom-left-radius': '0' });
                    }
                    else {
                        MessageAlert("ERROR", "NO reference found！");
                        return;
                    }
                });
                mesUI.SetLanguage("ActionCodeSetting");
            }
            $("#GoBack").click(function () {
                ClearAll();
            });
            function ClearAll() {
                //-----------------------------------
                var ClassName = "MESStation.Config.CActionCodeConfig";
                var FunctionName = "GetAllActionCode";
                self.parent.client.CallFunction(ClassName, FunctionName, {}, function (e) {
                    if (e.Status == "Pass") {
                        $("#ActionCodeView").show();
                        $("#ConfigView").hide();
                        //$("#TitleName").html("<lan set-lan='html:h_actioncode'>ActionCode</lan>");
                        $("#TitleName").removeAttr('set-lan').attr('set-lan', 'html:ActionCodeView');
                        $("#ACTION_CODE").val("");
                        $("#CHN_DESCRIPTION").val("");
                        $("#EN_DESCRIPTION").val("");
                        $('#ActionCodeTable').bootstrapTable("load", e.Data);
                        mesUI.SetLanguage("ActionCodeSetting");
                    }
                    else {
                        MessageAlert("ERROR", "NO reference found！");
                        return;
                    }
                });
                //-----------------------------------
            }
            //搜索框事件
            $("#Search").click(function () {
                var EValue = $.trim($("#SearchText").val());
                if (EValue.length < 1) {
                    MessageAlert("ERROR", " Please enter valid data！");
                    return;
                }
                var ClassName = "MESStation.Config.CActionCodeConfig";
                var FunctionName = "GetActionCodeByFuzzySearch";
                self.parent.client.CallFunction(ClassName, FunctionName, { SearchValue: EValue }, function (e) {
                    if (e.Status == "Pass") {
                        $('#ActionCodeTable').bootstrapTable("load", e.Data);
                    }
                    else {
                        MessageAlert("ERROR", "NO reference found！");
                        return;
                    }
                });
            });
            //清空搜索框返回列表
            $("#SearchText").change(function () {
                if ($.trim($("#SearchText").val()).length < 1) {
                    var ClassName = "MESStation.Config.CActionCodeConfig";
                    var FunctionName = "GetAllActionCode";
                    self.parent.client.CallFunction(ClassName, FunctionName, {}, function (e) {
                        if (e.Status == "Pass") {
                            $('#ActionCodeTable').bootstrapTable("load", e.Data);
                        }
                        else {
                            MessageAlert("ERROR", "NO reference found！");
                            return;
                        }
                    });
                }
            });
            $("#EN_DESCRIPTION").keydown(function (event) {
                if (event.keyCode == 13) {
                    $('#CHN_DESCRIPTION').focus();
                    $('#CHN_DESCRIPTION').select();
                }
            });
            $("#ACTION_CODE").keydown(function (event) {
                var EValue = $.trim($("#SearchText").val());
                if (event.keyCode == 13) {
                    ActionCodeAddFunction();
                }
            });
            $("#SearchText").keydown(function (event) {
                var EValue = $.trim($("#SearchText").val());
                if (event.keyCode == 13) {
                    if ($.trim($("#SearchText").val()).length > 0) {
                        var ClassName = "MESStation.Config.CActionCodeConfig";
                        var FunctionName = "GetActionCodeByFuzzySearch";
                        self.parent.client.CallFunction(ClassName, FunctionName, { SearchValue: EValue }, function (e) {
                            if (e.Status == "Pass") {
                                $('#ActionCodeTable').bootstrapTable("load", e.Data);
                            }
                            else {
                                MessageAlert("ERROR", "NO reference found！");
                                return;
                            }
                        });
                    }
                }
            });
            //增加按钮事件
            $("#AddClick").click(function () {
                var PrivilegeFlag = true;
                //預留權限
                if (LoginLevel == "9" || PrivilegeFlag == true) {
                    AddActionCode();
                }
                else {
                    MessageAlert("ERROR", "No permission to add operation！！");
                    return;
                }
            });
            function AddActionCode() {
                $("#ActionCodeView").hide();
                $("#ConfigView").show();
                //$("#TitleName").html("<lan set-lan='html:h_addactioncode'>AddActionCode</lan>");
                $("#TitleName").removeAttr('set-lan').attr('set-lan', 'html:h_AddActionCode');
                $("#ErrorMessage").attr("class", "form-group draggable");
                $("#MessageText").html("");
                $("#ACTION_CODE").removeAttr("readonly");
                $("#ACTION_CODE").focus();
                check = "ADD";
                mesUI.SetLanguage("ActionCodeSetting");
            }
            $("#ModifyClick").click(function () {
                var PrivilegeFlag = true;
                //預留權限
                if (LoginLevel == "9" || PrivilegeFlag == true) {
                    ModifyActionCode();
                }
                else {
                    MessageAlert("ERROR", "No permission to Edit！！");
                    return;
                }
            });
            function ModifyActionCode() {
                var Selections = $("#ActionCodeTable").bootstrapTable('getSelections');
                if (Selections.length < 1 || Selections.length > 1) {
                    MessageAlert("ERROR", "Please select a line to modify！");
                    return;
                }
                $("#ActionCodeView").hide();
                $("#ConfigView").show();
                //$("#TitleName").html("<lan set-lan='html:h_modifyacitoncode'>ModifyActionCode</lan>");
                $("#TitleName").removeAttr('set-lan').attr('set-lan', 'html:h_ModifyActionCode');
                $("#ACTION_CODE").val(Selections[0].ACTION_CODE);
                $("#ACTION_CODE").attr("readonly", "readonly");
                $("#ErrorMessage").attr("class", "form-group draggable");
                $("#MessageText").html("");
                $("#CHN_DESCRIPTION").val(Selections[0].CHINESE_DESCRIPTION);
                $("#EN_DESCRIPTION").val(Selections[0].ENGLISH_DESCRIPTION);
                $("#EN_DESCRIPTION").focus();
                check = "";
                mesUI.SetLanguage("ActionCodeSetting");
            }
            //刪除用戶權限
            $("#Delclick").click(function () {
                var PrivilegeFlag = true;
                //預留權限
                if (LoginLevel == "9" || PrivilegeFlag == true) {
                    DeleteActionCode();
                }
                else {
                    MessageAlert("ERROR", "No permission to add operation！！");
                    return;
                }
            });
            function DeleteActionCode() {
                var Selections = $("#ActionCodeTable").bootstrapTable('getSelections');
                if (Selections.length < 1) {
                    MessageAlert("ERROR", "Please select a line to delete！");
                    return;
                }
                else {
                    var DeleteCode = [];
                    for (var i = 0; i < Selections.length; i++) {
                        DeleteCode[i] = Selections[i].ACTION_CODE;
                    }
                    swal({
                        title: "Are you sure you want to remove " + Selections.length + " as an ActionCode?",
                        text: "Delete Action：" + DeleteCode,
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Delete",
                        closeOnConfirm: false
                    }, function () {
                        //-------------------------------------------------------
                        //删除事务
                        var ClassName = "MESStation.Config.CActionCodeConfig";
                        var FunctionName = "DeleteActionCodeById";
                        self.parent.client.CallFunction(ClassName, FunctionName, { Id: Selections[0].ID }, function (e) {
                            if (e.Status == "Pass") {
                                MessageAlert("OK", "DELETE OK！");
                                ClearAll();
                                return;
                            }
                            else {
                                MessageAlert("ERROR", "NO reference found！");
                                return;
                            }
                        });

                        //------------------------------------------------------
                        MessageAlert("OK", "The data you operated was deleted successfully！");
                        return;
                    });
                }
            }
            //Add点击SAVE触发事件
            $("#AddSave").click(function () {
                var SaveType = $("#TitleName").html();
                var Acode = $.trim($("#ACTION_CODE").val().toUpperCase());
                var Cdescripttion = $.trim($("#CHN_DESCRIPTION").val());
                var Edescripttion = $.trim($("#EN_DESCRIPTION").val());
                if (Acode.length < 2) {
                    MessageAlert("ERROR", "Please re-enter！The ActionCode must contain at last two characters！"); 
                    return;
                }
                if (Edescripttion.length < 1) {
                    MessageAlert("ERROR", "Please enter EN_DESCRIPTION！");
                    return;
                }
                if (Cdescripttion.length < 1) {
                    MessageAlert("ERROR", "Please enter CHN_DESCRIPTION！");
                    return;
                }
                var myReg = /^[a-zA-Z0-9_-]{0,}$/;
                if (!myReg.test(Acode)) {
                    MessageAlert("ERROR", "ACTION_CODE cannot contain Chinese or book special characters！");
                    return;
                }
                var edReg = /^[\u4e00-\u9fa5]+$/;
                if (edReg.test(Edescripttion)) {
                    MessageAlert("ERROR", "EN_DESCRIPTION cannot contain Chinese！");
                    return;
                }
                if (check == "ADD") {
                    swal({
                        title: "Do you want to add " + Acode + " as an ActionCode?",
                        text: "Data is priceless！",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#f8bb86",
                        confirmButtonText: "Insert",
                        closeOnConfirm: false
                    }, function () {
                        var ClassName = "MESStation.Config.CActionCodeConfig";
                        var FunctionName = "AddNewActionCode";
                        self.parent.client.CallFunction(ClassName, FunctionName, { ActionCode: Acode, EnglishDescription: Edescripttion, ChineseDescription: Cdescripttion }, function (e) {
                            if (e.Status == "Pass") {
                                MessageAlert("OK", "The data you operated has been updated successfully！");
                                $("#ACTION_CODE").val("");
                                $("#CHN_DESCRIPTION").val("");
                                $("#EN_DESCRIPTION").val("");
                                return;
                            }
                            else {
                                MessageAlert("ERROR", "Update missed. Please try again later！");
                                return;
                            }
                        });

                    });
                }
                else {
                    var Selections = $("#ActionCodeTable").bootstrapTable('getSelections');
                    var ClassName = "MESStation.Config.CActionCodeConfig";
                    var FunctionName = "GeActionCodeById";
                    self.parent.client.CallFunction(ClassName, FunctionName, { Id: Selections[0].ID }, function (e) {
                        if (e.Status == "Pass") {
                            if (Cdescripttion == e.Data.CHINESE_DESCRIPTION && Edescripttion == e.Data.ENGLISH_DESCRIPTION) {
                                MessageAlert("ERROR", "Please modify the content before submitting！！");
                                return;
                            }
                            else {
                                swal({
                                    title: "Are you sure you want to modify the information of " + Acode ,
                                    text: "The data is priceless, please operate with caution!",
                                    type: "warning",
                                    showCancelButton: true,
                                    confirmButtonColor: "#1ab394",
                                    confirmButtonText: "Modify",
                                    closeOnConfirm: false
                                }, function () {
                                    var Selections = $("#ActionCodeTable").bootstrapTable('getSelections');
                                    var ClassName = "MESStation.Config.CActionCodeConfig";
                                    var FunctionName = "UpdateActionCodeById";
                                    self.parent.client.CallFunction(ClassName, FunctionName, { Id: Selections[0].ID, ActionCode: Acode, EnglishDescription: Edescripttion, ChineseDescription: Cdescripttion }, function (e) {
                                        if (e.Status == "Pass") {
                                            MessageAlert("OK", "Your operation data has been updated successfully!");
                                            ClearAll();
                                            return;
                                        }
                                        else {
                                            MessageAlert("ERROR", "NO reference found！");
                                            return;
                                        }
                                    });
                                });
                            }
                        }
                        else {
                            MessageAlert("ERROR", "NO reference found！");
                            return;
                        }
                    });
                }
            });
            $("#ACTION_CODE").change(function () {
                ActionCodeAddFunction();
            });
            function ActionCodeAddFunction() {
                var Acode = $.trim($("#ACTION_CODE").val().toUpperCase());
                if (Acode.length > 0) {
                    var ClassName = "MESStation.Config.CActionCodeConfig";
                    var FunctionName = "GetByActionCode";
                    self.parent.client.CallFunction(ClassName, FunctionName, { ActionCode: Acode }, function (e) {
                        if (e.Status == "Pass") {
                            $("#MessageText").html("Your operation data has been updated successfully The entered "+ acode +" exists in the system!");
                            $("#ErrorMessage").attr("class", "form-group draggable has-error");
                            $("#ACTION_CODE").val("");
                            $('#ACTION_CODE').focus();
                            $('#ACTION_CODE').select();
                        }
                        else {
                            $('#EN_DESCRIPTION').focus();
                            $('#EN_DESCRIPTION').select();
                            $("#MessageText").html("");
                            $("#ErrorMessage").attr("class", "form-group draggable");
                        }
                    });
                }
                else {
                    $("#MessageText").html("");
                    $("#ErrorMessage").attr("class", "form-group draggable");
                }

            }
            //創建表格
            function ShowTable(Data, TableName) {
                var fie = [];
                var checkbox = "";
                fie.push({ title: 'checkall', field: 'checkall', checkbox: true, align: 'center' });
                for (var item in Data[0]) {
                    fie.push({ field: item, title: item });
                }
                $(TableName).bootstrapTable({
                    data: Data,
                    striped: false,                    //是否显示行间隔色
                    cache: false,                      //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                    sortable: false,                   //是否启用排序
                    sortOrder: "asc",                  //排序方式
                    pagination: true,                  //是否显示分页（*）
                    sidePagination: "client",          //分页方式：client客户端分页，server服务端分页（*）
                    pageNumber: 1,                     //初始化加载第一页，默认第一页
                    pageSize: 10,                       //每页的记录行数（*）
                    pageList: [10, 20, 60, 100],        //可供选择的每页的行数（*）
                    showColumns: false,                 //是否显示 内容列下拉框
                    showRefresh: false,                 //是否显示刷新按钮
                    minimumCountColumns: 2,            //最少允许的列数
                    clickToSelect: true,               //是否启用点击选中行
                    singleSelect: true,                //单选checkbox
                    showToggle: false,                  //是否显示详细视图和列表视图的切换按钮
                    cardView: false,                   //是否显示详细视图
                    detailView: false,                 //是否显示父子表
                    search: false,                      //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，
                    strictSearch: false,               //设置为 true启用 全匹配搜索，否则为模糊搜索
                    searchOnEnterKey: false,            //回车搜索
                    searchTimeOut: 500,                //设置搜索超时时间
                    trimOnSearch: true,                //设置为 true 将允许空字符搜索
                    searchAlign: "right",              //查询框对齐方式
                    toolbar: "#toolbar",       //指定工具栏
                    toolbarAlign: "left",              //工具栏对齐方式
                    buttonsAlign: "left",             //按钮对齐方式
                    showExport: true,                  //是否显示导出按钮
                    exportDataType: 'all',             //'basic', 'all', 'selected'  exportDataType表示导出的模式是当前页、所有数据还是选中数据
                    exportTypes: ['excel', 'csv'],     //导出文件类型
                    Icons: 'glyphicon-export',
                    exportOptions: {
                        ignoreColumn: [0],             //忽略某一列的索引
                        fileName: 'ActionCodeExcel',     //文件名称设置
                        worksheetName: 'sheet1',       //表格工作区名称
                    },
                    columns: fie,
                    locale: localelan //中文支持,
                });
                $(TableName).bootstrapTable('hideColumn', 'ID');
                $(TableName).bootstrapTable('hideColumn', 'EDIT_TIME');
                $(TableName).bootstrapTable('hideColumn', 'EDIT_EMP');
            }
            //MessgeBox
            function MessageAlert(MsgType, MsgTitle) {
                if (MsgType == "ERROR") {
                    swal({
                        title: MsgTitle,
                        text: "Warm tip: data is priceless, please operate with caution!",
                        type: "warning",
                        timer: 5000,
                        showConfirmButton: true
                    });
                }
                if (MsgType == "OK") {
                    swal({
                        title: MsgTitle,
                        text: "Warm tip: data is priceless, please operate with caution!！",
                        type: "success",
                        timer: 5000,
                        showConfirmButton: true
                    });
                }
            }
            // ---------------------------------------END---------------------------------------//
            LoadData();
        });
    </script>
</body>
</html>
