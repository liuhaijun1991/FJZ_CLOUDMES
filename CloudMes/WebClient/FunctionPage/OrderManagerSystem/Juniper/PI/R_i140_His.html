<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title set-lan="html:Title">Customer Forecast</title>
    <link href="../../../../css/plugins/bootstrap/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../../../../css/plugins/font-awesome/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../../../../css/animate.css" rel="stylesheet">
    <link href="../../../../css/style.css?v=4.1.0" rel="stylesheet">
    <link href="../../../../css/plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapTable/bootstrap-table.min.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapTable/bootstrap-editable.css" rel="stylesheet" />
    <link href="../../../../css/bu_manager.css" rel="stylesheet" />
    <link href="../../../../css/plugins/jQueryUI/jquery-ui.min.css" rel="stylesheet" />
    <link href="../../../../Scripts/plugins/layui/css/layui.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapDateTimePicker/bootstrap-datetimepicker.min.css" rel="stylesheet" />

    <style type="text/css">
        table, td, th {
            margin: 0;
            padding: 0 1px 1px;
            vertical-align: middle;
            text-align: left;
            border-color: white !important;
        }

        thead th {
            font-size: 10px !important;
            font-weight: bold;
            line-height: 10px !important;
            padding: 0 8px 2px;
            text-align: center;
            background: #4a4266 !important;
            color: #f0fcff;
        }

        .form-group .control-label {
            padding-top: 5px;
        }

        .SearchBox {
            color: #000;
            opacity: 1;
            width: 400px;
            height: auto;
            padding: 30px;
            background-color: #fff;
            position: fixed;
            border: solid 1.8px #75bfff;
            border-radius: 5px;
            min-width: 350px;
            z-index: 999;
        }

        .outputs {
            height: calc(100% - 54px);
            overflow-y: scroll;
        }

        .tools .fade {
            opacity: 0.9;
        }

        .intro {
            background-color: #C9C9C9;
            border: 2px solid #fff;
        }

        .introa {
            border: 1px solid #C9C9C9;
            font-size: 5px;
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
        }
        /*.introa{ border:3px solid #C9C9C9;font-size: 5px;margin-left: 0px;margin-top: 0px;margin-right: 0px;margin-bottom: 0px;}*/  
    </style>
</head>
<body class="full-height  animated fadeInRight">

    <div class="panel-heading bg-primary">
        <h3><i class="glyphicon glyphicon-tags"></i><span style="padding-left:10px;" set-lan="html:SKUSetting">Customer Forecast</span></h3>
    </div>

    <div class="panel-body">
        <div id="Table_Toolbar">
            <div class="form-inline" role="group">
                <div class="input-group">
                    <span class="input-group-addon">Plant</span>
                    <select class="form-control" id="select_plant">
                        <option value="-1">ALL</option>
                        <option value="FVN">FVN</option>
                        <option value="FJZ">FJZ</option>
                    </select>
                </div>
            </div>
        </div>
        <table id="tableList" class="table table-condensed"></table>
    </div>
    <div class="panel-body">

        <table title="已完成" id="tableListMain"></table>
    </div>
    <div id="divUploadInfo" class="hidden  form-horizontal ">
        <div class="col-xs-3" style="margin:10px 0px 10px 5px;">
            <div class="btn-group hidden-xs" style="padding-right:2000px">
                <label class="btn btn-primary " for="inputUploadFile" style="z-index:999;height: 34px;"><lan set-lan="html:Upload"> 文件路徑:</lan></label>
                <input id="inputUploadFile" type="file" class="btn btn-outline btn-primary file-outline" accept=".xlsx,.xlsm,.xlsb,.xls,.xltx,.xltm,.xlt,.xlam,.xla">
            </div>
        </div>
        <div class="col-xs-1 " style="margin:10px 0px 10px 0px;padding-left:0px;">
            <button type="button" class="btn btn-outline btn-primary" id="DownloadTemplateFile">
                <i class="glyphicon glyphicon-cloud-download" aria-hidden="true"></i><lan set-lan="html:Template"> 下載模板</lan>
            </button>
        </div>
        <div id="divExcel" class="div-excel">
        </div>
    </div>


    <div id="divsub" class="panel-body hidden" style="font-size: 1em;">
        
        <div id="Table_Toolbar_1">
            <div class="form-inline" role="group">
                <div class="input-group">
                    <div>
                        <button class="btn btn-success" id="DownloadExcel" onclick="DownloadExcel()">Export Excel</button>
                    </div>
                </div>
            </div>
        </div>
        <div><table id="subtableMaterial" class="table table-condensed"></table></div>
    </div>
    <!-- 全局js -->
    <script src="../../../../Scripts/plugins/jquery/jquery.min.js?v=2.1.4"></script>
    <script src="../../../../Scripts/plugins/jquery/jquery.cookie.js"></script>
    <script src="../../../../Scripts/plugins/bootstrap/bootstrap.min.js?v=3.3.6"></script>
    <script src="../../../../Scripts/plugins/JSON/json2.js"></script>
    <!-- 第三方插件 -->
    <script src="../../../../Scripts/plugins/jquery-ui/jquery-ui.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapDateTimePicker/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../../Scripts/plugins/JSON/json2.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-zh-TW.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-editable.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-editable.js"></script>
    <script src="../../../../Scripts/plugins/sweetalert/sweetalert.min.js"></script>
    <script src="../../../../Scripts/plugins/layer/layer.min.js"></script>
 
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-export.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/tableExport.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-zh-CN.min.js"></script>    
   
    <script src="../../../../Scripts/plugins/bootstrapDateTimePicker/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="../../../../Scripts/plugins/Knockout/knockout-3.5.0.js"></script>
    <script src="../../../../Scripts/plugins/Knockout/knockout.validation.min.js"></script>
    <script src="../../../../Scripts/plugins/excel/xlsx.full.min.js"></script>
    <script src="../../../../Scripts/plugins/excel/xlsx.core.min.js"></script>
    <script src="../../../../Scripts/plugins/excel/jquery.tabletojson.js"></script> 

    <script src="../../../../Scripts/global.js"></script>
    <script src="../../../../Scripts/MesClient.UI.js"></script>
    <script src="../../../../Scripts/MesClient.js"></script>
    <script>
        var mesUI = new MesClientUI(self.parent.client);
        var client = self.parent.client;
         
        $(document).ready(function () {
            LoadData();
            $("#divMsg").html("");
            var showExcel = document.getElementById("divExcel");
            $("#inputUploadFile").change(function (e) {
                $("#divExcel").html("");
                var filename = $("#inputUploadFile").val();
                if ((filename.indexOf(".xlsx") >= 0) || (filename.indexOf(".xlsm") >= 0) || (filename.indexOf(".xlsb") >= 0)
                    || (filename.indexOf(".xls") >= 0) || (filename.indexOf(".xltx") >= 0) || (filename.indexOf(".xltm") >= 0)
                    || (filename.indexOf(".xlt") >= 0) || (filename.indexOf(".xlam") >= 0) || (filename.indexOf(".xla") >= 0)) {
                    var reader = new FileReader();
                    reader.readAsArrayBuffer(e.target.files[0]);
                    reader.onload = function (e, callback) {
                        var data = new Uint8Array(reader.result);
                        var wb = XLSX.read(data, { type: 'array' });
                        var shitname = wb.SheetNames;
                        showExcel.innerHTML = "";
                        wb.SheetNames.forEach(function (sheetName) {
                            //var htmlstr = XLSX.write(wb, { sheet: shitname[0], type: 'binary', bookType: 'html' }); //binary為二進制方式，會導致中文亂碼
                            var htmlstr = XLSX.write(wb, { sheet: shitname[0], type: 'string', bookType: 'html' });
                            showExcel.innerHTML += htmlstr;
                        });
                        $("#divExcel").find("td").each(function () { $(this).text($(this).text().trim()); });
                        for (var i = 0; i < $("#divExcel").children("table").length; i++) {
                            $("#divExcel").children("table").eq(i).addClass("hidden");
                        }
                        $("#divExcel").children("table").eq(0).removeClass("hidden").addClass("table table-bordered table-hover");
                        $("#divExcel").children("table").eq(0).css("text-align", "center");
                        $("#divExcel").children("table").eq(0).attr({
                            "data-toggle": "table",
                            "data-classes": "table table-hover",
                            "data-height": "355"
                        });
                    }
                }
                else {

                    alert('Please select excel file with xlsx/xlsm/xlsb/xls/xltx/xltm/xlt/xlam/xla formats');
                }
            });
            $('#DownloadTemplateFile').on('click', function () {
                window.open("../../../File/upload_r_i285.xlsx");
            });
            $("#select_plant").on("change", function () {
                LoadData();
            });
        });

        function DownloadExcel() {
            $("#subtableMaterial").tableExport({
                type: 'excel',
                escape: 'false',
                fileName: 'I285'
            });
        }

        function LoadData() {
            $("#tableList").bootstrapTable('destroy');
            $("#tableListMain").bootstrapTable('destroy');
            var varplant = $("#select_plant").val();
            self.parent.client.CallFunction("MESJuniper.Api.R_i140Api", "GetR_i140_His", { Plant: varplant }, function (e) {
                if (e.Status == "Pass") {
                    layer.msg(e.Message, {
                        icon: 1,
                        time: 500
                    }, function () {
                        InitTable(e.Data);
                    });
                } else {
                    layer.msg(e.Message, {
                        icon: 2,
                        time: 3000
                    }, function () {
                    });
                    return;
                }
            });
        }

        function InitTable(obj) {
            $('#tableList').bootstrapTable({
                data: obj,
                title: "I140",
                striped: true, //是否显示行间隔色
                cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                pagination: true, //是否显示分页（*）
                sortable: false, //是否启用排序
                sortOrder: "asc", //排序方式
                sidePagination: "client", //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1, //初始化加载第一页，默认第一页
                pageSize: 10, //每页的记录行数（*）
                showColumns: false, //是否显示所有的列
                showRefresh: false, //是否显示刷新按钮
                minimumCountColumns: 2, //最少允许的列数
                clickToSelect: true, //是否启用点击选中行
                uniqueId: "ID", //每一行的唯一标识，一般为主键列
                showToggle: false, //是否显示详细视图和列表视图的切换按钮
                cardView: false, //是否显示详细视图
                detailView: false, //是否显示父子表
                dataType: "json", //期待返回数据类型
                method: "post", //请求方式
                searchAlign: "right", //查询框对齐方式
                search: true,
                buttonsAlign: "right", //按钮对齐方式
                toolbar: "#Table_Toolbar",
                toolbarAlign: "left", //工具栏对齐方式
                columns:
                    [
                        //{ field: '', title: '序号', formatter: function (value, row, index) { return index + 1; } },

                        { field: '', title: 'Serial number', formatter: function (value, row, index) { return index + 1; } },
                        {
                            field: 'PLANT',
                            title: '<label set-lan="html:PLANT">PLANT</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            sortable: true
                        },
                        {
                            field: 'TRANID',
                            title: '<label set-lan="html:TRANID">TRANID</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            sortable: true
                        }, {
                            field: 'WEEKNO',
                            title: '<label set-lan="html:WEEKNOWEEKNO">WEEK</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            sortable: true
                        }, {
                            field: 'YEARNO',
                            title: '<label set-lan="html:YEARNO">YEAR</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            sortable: true
                        }, {
                            field: 'COMPLETE',
                            title: '<label set-lan="html:COMPLETE">COMPLETE</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            sortable: true,
                            visible: false
                        }, {
                            field: 'PARTNUM',
                            title: '<label set-lan="html:PARTNUM">PARTNUM</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            visible: false,
                            sortable: true
                        }, {
                            field: 'ITEMNUM',
                            title: '<label set-lan="html:ITEMNUM">ITEMNUM</label>',
                            rowspan: 1,
                            align: 'center',
                            valign: 'middle',
                            visible: false,
                            sortable: true
                        },
                        //{
                        //    field: '一',
                        //    title: '<label set-lan="html:一">一</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '一', row);
                        //        }
                        //    }
                        //}, {
                        //    field: '二',
                        //    title: '<label set-lan="html:二">二</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '二', row);
                        //        }
                        //    }
                        //}
                        //, {
                        //    field: '三',
                        //    title: '<label set-lan="html:三">三</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '三', row);
                        //        }
                        //    }
                        //}
                        //, {
                        //    field: '四',
                        //    title: '<label set-lan="html:四">四</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '四', row);
                        //        }
                        //    }
                        //}
                        //, {
                        //    field: '五',
                        //    title: '<label set-lan="html:二">五</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '五', row);
                        //        }
                        //    }
                        //}, {
                        //    field: '六',
                        //    title: '<label set-lan="html:二">六</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '六', row);
                        //        }
                        //    }
                        //}, {
                        //    field: '日',
                        //    title: '<label set-lan="html:二">日</label>',
                        //    rowspan: 1,
                        //    align: 'center',
                        //    valign: 'middle',
                        //    sortable: true,
                        //    cellStyle: function (value, row, index) {
                        //        var bgc = "";
                        //        if (value == "Y") bgc = "#99ff33"; else bgc = "#ff0000";
                        //        return {
                        //            "css": {
                        //                "background-color": bgc
                        //            }
                        //        };
                        //    },
                        //    formatter: operateFormattercolor,
                        //    events: {
                        //        "click .info": function (ev, value, row, index) {
                        //            dc(value, '日', row);
                        //        }
                        //    }
                        //},
                         {
                            field: 'operate',
                            title: 'Operate',
                            align: 'center',
                            width: '10%',
                            events: "operateEvents",
                            formatter: operateFormatter
                        }, {
                            field: 'CREATETIME',
                            title: '<label set-lan="html:CREATETIME">CREATETIME</label>',
                            rowspan: 1,
                            width: '10%',
                            align: 'center',
                            valign: 'middle',
                            sortable: true
                        }, {
                            field: 'EDITTIME',
                            title: '<label set-lan="html:EDITTIME">EDITTIME</label>',
                            rowspan: 1,
                            width: '10%',
                            align: 'center',
                            valign: 'middle',
                            sortable: true
                        }
                    ],
                  rowStyle: function (row, index) {
                    var classes = ['active', 'success', 'info', 'warning', 'danger'];
                      if (row.COMPLETE === "0")
                          return {
                              classes: classes[4]
                          }
                      else
                          return {
                              classes: classes[1]
                          }
                }
            });
            $('#tableList').on('click', 'td:has(.editable)', function (e) {
                e.stopPropagation(); // 阻止事件的冒泡行为
                $(this).find('.editable').editable('show'); // 打开被点击单元格的编辑状态
            });

        }

        function dc(val,d,row) {
            if (val == "N") {
                var mydate = new Date();
                var day = mydate.getDay();
                day = GetDay(day);
                if (day != d) { 
                        layer.msg("當前系統為周" + day + ",你不能上傳周" + d + "的數據(只能上傳當天的數據)", {
                            icon: 1,
                            time: 3000
                        },
                            function () {
                                
                            });

                   // alert("當前系統為周" + day + ",你不能上傳周" + d + "的數據(只能上傳當天的數據)");
                    return;
                }
                upload_r_i285(row.TRANID,d);                
            }
            else if (val == "Y") {                
                GetFILENAME(row.TRANID, d);                
            }
        }
        function GetDay(day)
        {
            var outday = "";
            if (day == "0")
            {
                outday = "日";
            }
            else if (day == "1") {
                outday = "一";
            }
            else if (day == "2") {
                outday = "二";
            }
            else if (day == "3") {
                outday = "三";
            }
            else if (day == "4") {
                outday = "四";
            }
            else if (day == "5") {
                outday = "五";
            }
            else if (day == "6") {
                outday = "六";
            }
            return outday;
        }
        function GetFILENAME(TRANID, DAY)
        {
            var FILENAME=""
            self.parent.client.CallFunction("MESJuniper.Api.R_i140Api", "GetR_i285_FILENAME", { TRANID: TRANID, DAY: DAY }, function (e) {
                if (e.Status == "Pass") {
                    layer.msg(e.Message, {
                        icon: 1,
                        time: 500
                    },
                        function () {
                        FILENAME = e.Data;
                        open_r_i285(FILENAME);
                    });
                } else {
                    layer.msg(e.Message, {
                        icon: 2,
                        time: 3000
                    }, function () {
                    });
                     ;
                }
            });
            
        }

        function upload_r_i285(TRANID, DAY) {

            var layermid = layer.open({
                id: "UploadData",
                type: 1,
                shade: 0.8,
                shadeClose: false,
                title: "上傳R_i285," + TRANID + "," + DAY,
                area: ['90%', '90%'],
                content: $('#divUploadInfo'),
                //btn: ["上傳", "取消"],
                btn: ["Upload", "Cancel"],
                success: function (layero, index) {
                    $("#divUploadInfo").removeClass("hidden");
                    $("#inputUploadFile").val("");
                    $("#excelTable").html("");
                    $("#divMsg").html("");
                },
                end: function () {
                    $("#divUploadInfo").addClass("hidden");
                },
                yes: function (index) {
                    var layerIndex = layer.open({
                        type: 1,
                        title: false,
                        closeBtn: 0,
                        shadeClose: false,
                        skin: 'layer_shin',
                        offset: 'aotu',
                        content: " <div style='background-color:transparent; border: 1px solid #fff;border-radius: 15px;padding:10px 5px;'> <div class=''><div class= 'sk-spinner sk-spinner-wave'><div class='sk-rect1'></div>"
                            + "<div class='sk-rect2'></div><div class='sk-rect3'></div><div class='sk-rect4'></div><div class='sk-rect5'></div></div >"
                            //+ "<div class='text-center font-bold note-fontsize-10'>系統正在加急處理,請耐心等待 ...</div></div ></div >"
                            + "<div class='text-center font-bold note-fontsize-10'>The system is processing urgently,Please wait patiently ...</div></div ></div >"
                    });
                    var uploadData = $("#divExcel").children("table").eq(0).tableToJSON(); // Convert the table into a javascript object
                    parent.client.CallFunction("MESJuniper.Api.R_i140Api", "UploadR_i285Excel", { ExcelData: JSON.stringify(uploadData), TRANID: TRANID, DAY: DAY }, function (e) {
                        if (e.Status == "Pass") {
                            layer.msg(e.Message, {
                                icon: 1,
                                time: 60000,
                                title: 'Tip',
                                btn: ['OK']
                            }, function () {
                                $("#inputUploadFile").val("");
                                $("#divMsg").html(e.Message);
                                $("#divExcel").html("");
                                layer.close(layerIndex);
                                layer.close(layermid);
                                LoadData();
                            });
                        } else {
                            layer.msg(e.Message, {
                                icon: 2,
                                time: 60000,
                                title: 'ERROR',
                                btn: ['OK']
                            }, function () {
                                $("#divMsg").html(e.Message);
                                layer.close(layerIndex);
                                //  GetList();
                            });
                        }

                    });
                },
                cancel: function (index) {
                    $("#inputUploadFile").val("");
                    $("#excelTable").html("");
                    layer.close(index);
                    //  GetList();
                }

            });


        }
        function open_r_i285(F) {
            //var d = F.substr(0, 4) + "年" + F.substr(4, 2) + "月" + F.substr(6, 2) + "日";
            var d = F.substr(0, 4) + "Year" + F.substr(4, 2) + "Month" + F.substr(6, 2) + "Day";
            layer.open({
                type: 1,
                //title: "R_I285,上傳日期:" + d + "文件名:"+F,
                title: "R_I285,Upload date:" + d + "file name:" + F,
                area: ['90%', '90%'],
                offset: ["0px", "0px"],
                skin: 'mes-layer-title',
                scrollbar: false,
                content: $("#divsub"),
                success: function (layero, index) {
                    $("#divsub").removeClass("hidden");
                    InitR_I285(F);
                },
                end: function () {
                    $("#divsub").addClass("hidden");
                }
            });

        }
         
        var InitSubTable = function (row) {
            self.parent.client.CallFunction("MESJuniper.Api.R_i140Api",
                "GetR_i140_rebuiltDataByTRANID",
                { TRANID: row },
                function (e) {

                    e = JSON.parse(JSON.stringify(e).replaceAll("'", "").replaceAll("null", "0"));

                    var columnsArray = [];
                    columnsArray.push({ field: "state", checkbox: true });
                    //columnsArray.push({ field: '', title: '序号', formatter: function (value, row, index) { return index + 1; } });
                    columnsArray.push({ field: '', title: 'Serial number', formatter: function (value, row, index) { return index + 1; } });

                    for (var p in e.Data[0]) {
                        var property = p;
                        columnsArray.push({
                            "title": property,
                            "field": property,
                            switchable: true,
                            align: "center",
                            sortable: true
                        });
                    }

                    $("#subtableMaterial").bootstrapTable('destroy');
                    if (e.Data.length > 0) {
                        $("#subtableMaterial").bootstrapTable({
                            data: e.Data,
                            striped: true, //是否显示行间隔色
                            cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                            pagination: true, //是否显示分页（*）
                            sortable: false, //是否启用排序
                            sortOrder: "asc", //排序方式
                            sidePagination: "client", //分页方式：client客户端分页，server服务端分页（*）
                            pageNumber: 1, //初始化加载第一页，默认第一页
                            pageSize: 10, //每页的记录行数（*）
                            showColumns: false, //是否显示所有的列
                            showRefresh: false, //是否显示刷新按钮
                            minimumCountColumns: 2, //最少允许的列数
                            clickToSelect: true, //是否启用点击选中行
                            uniqueId: "ID", //每一行的唯一标识，一般为主键列
                            showToggle: false, //是否显示详细视图和列表视图的切换按钮
                            cardView: false, //是否显示详细视图
                            detailView: false, //是否显示父子表
                            dataType: "json", //期待返回数据类型
                            method: "post", //请求方式
                            searchAlign: "right", //查询框对齐方式
                            search: true,
                            buttonsAlign: "right", //按钮对齐方式
                            toolbar: "#divTableToolbar", //指定工具栏
                            toolbarAlign: "left", //工具栏对齐方式
                            columns: columnsArray
                        });

                        function aFormatter(value, row, index) {
                            if (value == 0)
                                return value;
                            else
                                return [
                                    '<button id="bind" type="button" class="btn btn-link"><span class=\"layui-badge layui-bg-dot\">' + value + '</span></button>'
                                ].join("");
                        };
                    } else {
                        layer.closeAll();
                        //layer.msg('未上傳285或上傳失敗', {
                        //    time: 20000, //20s后自动关闭
                        //    btn: ['明白了']
                        //});

                        layer.msg('Not uploaded 285 or upload failed', {
                            time: 20000, //20s后自动关闭
                            btn: ['understood']
                        });
                    }
                });
        };
         
        var InitR_I285 = function (FILENAME) {
            self.parent.client.CallFunction("MESJuniper.Api.R_i140Api",
                "GetR_i285_rebuiltDataByTRANID",
                { FILENAME: FILENAME },
                function (e) {
                    e = JSON.parse(JSON.stringify(e).replaceAll("'", "").replaceAll("null", "0"));
                    var columnsArray = [];                    
                    //columnsArray.push({ field: '', title: '序号', formatter: function (value, row, index) { return index + 1; } });
                    columnsArray.push({ field: '', title: 'serial number', formatter: function (value, row, index) { return index + 1; } });

                    for (var p in e.Data[0]) {
                        var property = p;
                        columnsArray.push({
                            "title": property,
                            "field": property,
                            switchable: true,
                            align: "center",
                            sortable: true
                        });
                    }

                    $("#subtableMaterial").bootstrapTable('destroy');
                    if (e.Data.length > 0) {
                        $("#subtableMaterial").bootstrapTable({
                            data: e.Data,
                            striped: true, //是否显示行间隔色
                            cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                            pagination: true, //是否显示分页（*）
                            sortable: false, //是否启用排序
                            sortOrder: "asc", //排序方式
                            sidePagination: "client", //分页方式：client客户端分页，server服务端分页（*）
                            pageNumber: 1, //初始化加载第一页，默认第一页
                            pageSize: 10000, //每页的记录行数（*）
                            showColumns: false, //是否显示所有的列
                            showRefresh: false, //是否显示刷新按钮
                            minimumCountColumns: 2, //最少允许的列数
                            clickToSelect: true, //是否启用点击选中行
                            uniqueId: "ID", //每一行的唯一标识，一般为主键列
                            showToggle: false, //是否显示详细视图和列表视图的切换按钮
                            cardView: false, //是否显示详细视图
                            detailView: false, //是否显示父子表
                            dataType: "json", //期待返回数据类型
                            method: "post", //请求方式
                            searchAlign: "right", //查询框对齐方式
                            search: true,
                            buttonsAlign: "right", //按钮对齐方式
                            toolbar: "#Table_Toolbar_1", //指定工具栏
                            toolbarAlign: "left", //工具栏对齐方式
                            columns: columnsArray
                        });

                        function aFormatter(value, row, index) {
                            if (value == 0)
                                return value;
                            else
                                return [
                                    '<button id="bind" type="button" class="btn btn-link"><span class=\"layui-badge layui-bg-dot\">' + value + '</span></button>'
                                ].join("");
                        };
                    } else {
                        layer.closeAll();
                        //layer.msg('未上傳R_I285', {
                        //    time: 20000, //20s后自动关闭
                        //    btn: ['明白了']
                        //});
                        layer.msg('Not uploaded R_I285', {
                            time: 20000, //20s后自动关闭
                            btn: ['understood']
                        });
                    }
                });
        };
         

        function operateFormatter(value, row, index) {
            var cqaBtn, gtBtn;
            cqaBtn = '<button type="button" class="RoleOfA btn btn-success  btn-sm" style="margin-right:15px;">DataInfo</button>';
            return [cqaBtn].join('');
        }

        function operateFormatter_f(value, row, index) {
            var detailBtn, r_140Btn;
            detailBtn = '<button type="button" class="RoleOfB btn btn-success  btn-sm" style="margin-right:15px;">detail</button>';
            r_140Btn = '<button type="button" class="RoleOfA btn btn-success  btn-sm" style="margin-right:15px;">DataInfo</button>';
            return [detailBtn, r_140Btn].join('');
        }

        function operateFormattercolor(value, row, index) {
            //if (value == "N") {
            //    return ['<span onclick ="upload_r_i285()" style="color:red">' + value + '</span>'];
            //}
            //else if (value == "Y") {
            //    return ['<span onclick ="open_r_i285(' + row.TRANID + ')"  style="color:green">' + value + '</span>'];

            //}
            //else {
            //    return ['<span >' + value + '</span>'];
            //}

            return '<button class="btn btn-info btn-outline info">' + value + '</button>';

            //if (value == "N") {
            //    return ['<span onclick ="upload_r_i285()" >' + value + '</span>'];
            //}
            //else if (value == "Y") {
            //    return ['<span onclick ="open_r_i285(' + row.TRANID + ')" >' + value + '</span>'];

            //}
            //else {
            //    return ['<span >' + value + '</span>'];
            //}
        }


        window.operateEvents = {
            'click .RoleOfA': function (e, value, row, index) {
                var url = "R_i140_rebuilt_byid.html?TRANID=" + row.TRANID;
                //var titletext = "I140信息/TranID:" + row.TRANID+ "/CreateTime:"+ row.CREATETIME;
                var titletext = "I140information/TranID:" + row.TRANID + "/CreateTime:" + row.CREATETIME;

                layer.open({
                    title: titletext,
                    type: 2,
                    skin: 'layui-layer-demo', //样式类名
                    anim: 2,
                    maxmin: true,
                    area: ['90%', '90%'], //宽高
                    content: [url, 'yes'],
                    cancel: function (index) {
                    }
                });
            },
            'click .RoleOfB': function (e, value, row, index) {
                var url = "R_i140_Main_D.html?TRANID=" + row.TRANID;
                layer.open({
                    //title: "CQA信息",
                    title: "CQA information",
                    type: 2,
                    skin: 'layui-layer-demo', //样式类名
                    anim: 2,
                    maxmin: true,
                    area: ['90%', '90%'], //宽高
                    content: [url, 'no'],
                    cancel: function (index) {
                    }
                });
            }
        };

    </script>

</body>
</html>

