<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title set-lan="html:Title">I140Comparison</title>
    <link href="../../../../css/plugins/jQueryUI/jquery-ui.min.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrap/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../../../../css/plugins/font-awesome/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../../../../css/animate.css" rel="stylesheet">
    <link href="../../../../css/style.css?v=4.1.0" rel="stylesheet">
    <link href="../../../../css/plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapTable/bootstrap-table.min.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapTable/bootstrap-editable.css" rel="stylesheet" />
    <link href="../../../../Scripts/plugins/layui/css/layui.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapSelect/bootstrap-select.min.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapDateTimePicker/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../../../../css/plugins/bootstrapTable/bootstrap-table-fixed-columns.min.css" rel="stylesheet" />
    <style type="text/css">
        @media(max-width:1599px) {
            #GTPanel {
                margin: 0 auto;
                width: calc((100% - 30px));
            }
        }

        body {
            background: #EEF4FB
        }

        table, td, th {
            margin: 0;
            padding: 0;
            vertical-align: middle;
            text-align: left;
            border-color: #BFC9D5 !important;
            font-size: xx-small;
            background: #fff !important;
        }

        thead th {
            font-size: 8px;
            font-weight: inherit !important;
            line-height: 19px;
            padding: 0 5px 2px;
            text-align: center;
            background: #DBE0E4 !important;
            --background: white !important;
            --color: white;
        }
        /*table, th {
            background: #ffffff !important;
        }*/
        .nodatabox {
            display: table;
            width: 60%;
            text-align: center;
            color: #777;
            vertical-align: middle;
            text-align: center;
        }

        .container {
            margin: 0;
            width: calc((100% - 30px));
        }

        .nodatabox img {
            width: 50%;
        }

        .lineTd {
            background: #d3dafa url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxsaW5lIHgxPSIwIiB5MT0iMCIgeDI9IjEwMCUiIHkyPSIxMDAlIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjEiLz48L3N2Zz4=) no-repeat 100% center !important;
        }

    </style>
</head>
<body class="full-height  animated fadeInRight">
    <div id="divsub" class="panel-body" style="font-size: 1em;">
        <div class="col-xs-12">
            <div class="fixed-table-toolbar">
                <div class="btn-group div-table-tool" id="tableResToolbar" role="group">                    
                    <button type="button" class="btn btn-outline btn-default" id="btnDownloadRes">
                        <i class="glyphicon glyphicon-download" aria-hidden="true"></i><lan set-lan="html:">Download</lan>
                    </button>
                </div>
            </div>
            <table id="ComparisonRes" class="table table-condensed text-nowrap" style="height:200px"></table>
        </div>
        <b />
        <div class="col-xs-12">
            <div class="col-xs-6 layui-input-inline">
                <div class="fixed-table-toolbar">
                    <div class="btn-group div-table-tool" id="tableAmountToolbar" role="group">
                        <button type="button" class="btn btn-outline btn-default" id="btnDownloadAmount">
                            <i class="glyphicon glyphicon-download" aria-hidden="true"></i><lan set-lan="html:">Download</lan>
                        </button>
                    </div>
                </div>
                <table id="Amountdt" class="table table-condensed text-nowrap" style="height:200px"></table>
            </div>

            <div class="col-xs-6 layui-input-inline">
                <div class="fixed-table-toolbar">
                    <div class="btn-group div-table-tool" id="tableQtyToolbar" role="group">
                        <button type="button" class="btn btn-outline btn-default" id="btnDownloadQty">
                            <i class="glyphicon glyphicon-download" aria-hidden="true"></i><lan set-lan="html:">Download</lan>
                        </button>
                    </div>
                </div>
                <table id="Qtydt" class="table table-condensed text-nowrap" style="height:200px"></table>
            </div>
        </div>
        <b />
        <b />
    </div>

    <!-- 全局js -->
    <script src="../../../../Scripts/plugins/jquery/jquery.min.js?v=2.1.4"></script>
    <script src="../../../../Scripts/plugins/jquery/jquery.cookie.js"></script>
    <script src="../../../../Scripts/plugins/bootstrap/bootstrap.min.js?v=3.3.6"></script>
    <!-- 第三方插件 -->

    <script src="../../../../Scripts/plugins/bootstrapDateTimePicker/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../../Scripts/plugins/jquery-ui/jquery-ui.js"></script>
    <script src="../../../../Scripts/plugins/JSON/json2.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-zh-TW.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-editable.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-editable.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapSelect/bootstrap-select.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-fixed-columns.js"></script>
    <script src="../../../../Scripts/plugins/sweetalert/sweetalert.min.js"></script>
    <script src="../../../../Scripts/plugins/layer/layer.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/bootstrap-table-export.min.js"></script>
    <script src="../../../../Scripts/plugins/bootstrapTable/tableExport.min.js"></script>
    <script src="../../../../Scripts/plugins/Knockout/knockout-3.5.0.js"></script>
    <script src="../../../../Scripts/plugins/Knockout/knockout.validation.min.js"></script>
    <script src="../../../../Scripts/plugins/excel/xlsx.full.min.js"></script>
    <script src="../../../../Scripts/plugins/excel/xlsx.core.min.js"></script>
    <script src="../../../../Scripts/plugins/excel/jquery.tabletojson.js"></script>
    <script src="../../../../Scripts/global.js"></script>
    <script src="../../../../Scripts/MesClient.UI.js"></script>
    <script src="../../../../Scripts/MesClient.js"></script>
    <script>
        var mesUI = new MesClientUI(self.parent.client);
        var lan = $.cookie($.MES.CK_LAN_NAME);
        var loadindex = 0, loadcont = 0;
        var i140Akey = $.MES.getQueryString("Akey");
        var i140Bkey = $.MES.getQueryString("Bkey");
        $(document).ready(function () {
            initpage();
            $("#btnDownloadRes").click(function () {
                var loadindex = layer.load(0, { shade: [0.8, '#393d49'] });
                parent.client.CallFunction("MESJuniper.Api.R_i140Api", "DownloadComparisonRes", { I140Akey: i140Akey, I140Bkey: i140Bkey }, function (e) {
                    if (e.Status == "Pass") {
                        var blob = b64toBlob(e.Data.Content);
                        if (window.navigator.msSaveOrOpenBlob) {
                            navigator.msSaveBlob(blob, e.Data.FileName);
                        } else {
                            var link = document.createElement('a');
                            link.href = window.URL.createObjectURL(blob);
                            link.download = e.Data.FileName;
                            link.click();
                            window.URL.revokeObjectURL(link.href);
                        }
                        layer.close(loadindex);
                    } else {
                        layer.msg(e.Message, {
                            icon: 2,
                            time: 60000,
                            title: 'ERROR',
                            btn: ['OK']
                        }, function () {
                            $("#divMsg").html(e.Message);
                            layer.close(layerIndex);
                        });
                    }
                });
            });
            $("#btnDownloadAmount").click(function () {
                var loadindex = layer.load(0, { shade: [0.2, '#393d49'] });
                parent.client.CallFunction("MESJuniper.Api.R_i140Api", "DownloadComparisonAmountRes", { I140Akey: i140Akey, I140Bkey: i140Bkey }, function (e) {
                    if (e.Status == "Pass") {
                        var blob = b64toBlob(e.Data.Content);
                        if (window.navigator.msSaveOrOpenBlob) {
                            navigator.msSaveBlob(blob, e.Data.FileName);
                        } else {
                            var link = document.createElement('a');
                            link.href = window.URL.createObjectURL(blob);
                            link.download = e.Data.FileName;
                            link.click();
                            window.URL.revokeObjectURL(link.href);
                        }
                        layer.close(loadindex);
                    } else {
                        layer.msg(e.Message, {
                            icon: 2,
                            time: 60000,
                            title: 'ERROR',
                            btn: ['OK']
                        }, function () {
                            $("#divMsg").html(e.Message);
                            layer.close(layerIndex);
                        });
                    }
                });
            });
            $("#btnDownloadQty").click(function () {
                var loadindex = layer.load(0, { shade: [0.2, '#393d49'] });
                parent.client.CallFunction("MESJuniper.Api.R_i140Api", "DownloadComparisonQtyRes", { I140Akey: i140Akey, I140Bkey: i140Bkey }, function (e) {
                    if (e.Status == "Pass") {
                        var blob = b64toBlob(e.Data.Content);
                        if (window.navigator.msSaveOrOpenBlob) {
                            navigator.msSaveBlob(blob, e.Data.FileName);
                        } else {
                            var link = document.createElement('a');
                            link.href = window.URL.createObjectURL(blob);
                            link.download = e.Data.FileName;
                            link.click();
                            window.URL.revokeObjectURL(link.href);
                        }
                        layer.close(loadindex);
                    } else {
                        layer.msg(e.Message, {
                            icon: 2,
                            time: 60000,
                            title: 'ERROR',
                            btn: ['OK']
                        }, function () {
                            $("#divMsg").html(e.Message);
                            layer.close(layerIndex);
                        });
                    }
                });
            });
        });
        var b64toBlob = function (b64Data, sliceSize) {
            sliceSize = sliceSize || 512;
            var byteCharacters = atob(b64Data);
            var byteArrays = [];
            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                var slice = byteCharacters.slice(offset, offset + sliceSize);
                var byteNumbers = new Array(slice.length);
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            var blob = new Blob(byteArrays);
            return blob;
        };
        var GetComparisonRes = function () {
            var loadindex = layer.load(0, { shade: [0.8, '#393d49'] });
            parent.client.CallFunction("MESJuniper.Api.R_i140Api", "GetComparisonRes", { I140Akey: i140Akey, I140Bkey: i140Bkey }, function (e) {
                if (e.Status == "Pass") {
                    e = JSON.parse(JSON.stringify(e).replaceAll("'", "").replaceAll("null", "0"));
                    InitTable(e.Data, $('#ComparisonRes'), "right","#tableResToolbar");
                    layer.close(loadindex);
                } else {
                    layer.msg(e.Message, {
                        icon: 2,
                        time: 60000,
                        title: 'ERROR',
                        btn: ['OK']
                    }, function () {
                        $("#divMsg").html(e.Message);
                        layer.close(layerIndex);
                    });
                }
            });
        };

        var GetComparisonQtyRes = function () {
            var loadindex = layer.load(0, { shade: [0.8, '#393d49'] });
            parent.client.CallFunction("MESJuniper.Api.R_i140Api", "GetComparisonQtyRes", { I140Akey: i140Akey, I140Bkey: i140Bkey }, function (e) {
                if (e.Status == "Pass") {
                    InitTable(e.Data, $('#Qtydt'), "right","#tableQtyToolbar");
                    layer.close(loadindex);
                } else {
                    layer.msg(e.Message, {
                        icon: 2,
                        time: 60000,
                        title: 'ERROR',
                        btn: ['OK']
                    }, function () {
                        $("#divMsg").html(e.Message);
                        layer.close(layerIndex);
                    });
                }
            });
        };

        var GetComparisonAmountRes = function () {
            var loadindex = layer.load(0, { shade: [0.2, '#393d49'] });
            parent.client.CallFunction("MESJuniper.Api.R_i140Api", "GetComparisonAmountRes", { I140Akey: i140Akey, I140Bkey: i140Bkey }, function (e) {
                if (e.Status == "Pass") {
                    InitTable(e.Data, $('#Amountdt'), "right","#tableAmountToolbar");
                    layer.close(loadindex);
                } else {
                    layer.msg(e.Message, {
                        icon: 2,
                        time: 60000,
                        title: 'ERROR',
                        btn: ['OK']
                    }, function () {
                        $("#divMsg").html(e.Message);
                        layer.close(layerIndex);
                    });
                }
            });
        };

        var initpage = function () {
            GetComparisonRes();
            GetComparisonQtyRes();
            GetComparisonAmountRes();
        };

        var InitTable = function (obj, tablesite, searchAlign, toolbar) {
            var col = [];
            if (obj.maindata.length > 0) {
                var row = obj.maindata[0];
                for (var item in row)
                    if ("PN,TRANID,GROUP".indexOf(item) == -1)
                        col.push({
                            field: item,
                            title: item,
                            width: 220,
                            align: 'center',
                            valign: 'middle',
                            formatter: function (val, row, index) {
                                var wash = obj.assist.filter(t => t.PN == row["PN"] && t.SDate == this.field);
                                if (wash != undefined && wash.length === 1) {
                                    switch (wash[0].Flag) {
                                        case "D": return "<s>" + val + "</s>";
                                            break;
                                        case "C": return "<span style=\"float:left;margin-top:10px;color:green!important;font-weight:bolder;\">" + wash[0].CQty + "</span ><span style=\"float:right;margin-top:0px;color:red!important;font-weight:bolder;font-style:oblique;\"><s>" + wash[0].LQty + "</s></span>";
                                            break;
                                        case "A": return "<span style=\"font-weight:bolder!important;\">" + val + "</span>";
                                            break;
                                        default: break;
                                    }
                                } else
                                    return val;
                            },
                            cellStyle: function (value, row, index, field) {
                                var wash = obj.assist.filter(t => t.PN == row["PN"] && t.SDate == field);
                                if (wash != undefined && wash.length === 1) {
                                    switch (wash[0].Flag) {
                                        case "D": return { css: { "background-color": "#f1dacf!important", "color": "#8a0303", "font-weight": "bold" } }
                                            break;
                                        case "C": //return {css: { "background":"#faebdd url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxsaW5lIHgxPSIwIiB5MT0iMCIgeDI9IjEwMCUiIHkyPSIxMDAlIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjEiLz48L3N2Zz4=) no-repeat 100% center !important"} }
                                            return {
                                                css: {
                                                    "background": "#faebdd!important"
                                                }
                                            }
                                            break;
                                        case "A": return { css: { "background-color": "#e4f5fa!important" } }
                                            break;
                                        default: break;
                                    }
                                } else
                                    return { css: { "font-weight": "bold" } }
                            }
                        });
                    else
                        col.push({
                            field: item,
                            title: item,
                            align: 'center',
                            valign: 'middle',
                            formatter: function (val, row, index) {
                                var wash = obj.delpn.filter(t => t.PN == row["PN"]);
                                if (wash != undefined && wash.length > 0) {
                                    return "<s>" + val + "</s>";
                                } else
                                    return val;
                            },
                            cellStyle: function (value, row, index, field) {
                                var wash = obj.delpn.filter(t => t.PN == row["PN"]);
                                if (wash != undefined && wash.length > 0) {
                                    return { css: { "background-color": "#f1dacf!important", "color": "#8a0303", "font-weight": "bold" } }
                                } else
                                    return { css: { "color": "#300c01", "font-weight": "bolder" } }
                            }
                        });

                tablesite.bootstrapTable('destroy');
                tablesite.bootstrapTable({
                    data: obj.maindata,
                    striped: true,                      //是否显示行间隔色
                    cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                    pagination: false,                   //是否显示分页（*）
                    sortable: false,                    //是否启用排序
                    sortOrder: "asc",                   //排序方式
                    sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                    height: 400,
                    striped: true, //是否显示行间隔色
                    showColumns: false,                 //是否显示所有的列
                    showRefresh: false,                  //是否显示刷新按钮
                    minimumCountColumns: 2,             //最少允许的列数
                    clickToSelect: true,                //是否启用点击选中行
                    uniqueId: "ID",                     //每一行的唯一标识，一般为主键列
                    showToggle: false,                  //是否显示详细视图和列表视图的切换按钮
                    cardView: false,                    //是否显示详细视图
                    detailView: false,                  //是否显示父子表
                    dataType: "json",                   //期待返回数据类型
                    method: "post",                     //请求方式
                    searchAlign: searchAlign,               //查询框对齐方式
                    search: true,
                    buttonsAlign: "right",               //按钮对齐方式
                    toolbar: toolbar,        //指定工具栏
                    toolbarAlign: "left",               //工具栏对齐方式
                    //showExport: true,                  //是否显示导出按钮
                    //exportDataType: 'all',             //'basic', 'all', 'selected'  exportDataType表示导出的模式是当前页、所有数据还是选中数据
                    //exportTypes: ['excel', 'csv'],     //导出文件类型
                    //Icons: 'glyphicon-export',
                    //exportOptions: {
                    //    ignoreColumn: [0],             //忽略某一列的索引
                    //    fileName: 'List',     //文件名称设置
                    //    worksheetName: 'sheet1',       //表格工作区名称
                    //    //excelstyles: ['backgroup-color','color','font-size','font-weight']
                    //},
                    columns: col
                });
            }
        }

    </script>

</body>
</html>

